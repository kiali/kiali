name: Kiali Molecule Tests

on:
  schedule:
  - cron: '0 6 * * *' # This is UTC time
  workflow_dispatch:
    inputs:
      all_tests:
        description: "Molecule Test Names (space-separated)"
        required: false
        default: ""
        type: string
      olm_version:
        description: "Version of OLM to install or 'latest'. e.g. v0.28.0"
        required: false
        default: "latest"
        type: string
      last_n_istio_versions:
        description: "The last N minor versions of Istio to test. Default is 3 meaning test with the latest version of Istio, along with the previous two minor version releases."
        required: false
        default: 3
        type: number

jobs:
  molecules:
    name: Molecule tests
    runs-on: ubuntu-20.04
    steps:
    - name: Checkout the hack script that runs the tests
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          hack/ci-kind-molecule-tests.sh
    - name: Print the names of the tests that are to be run
      run: |
        if [ -z "${{ inputs.all_tests }}" ]; then
          echo "all tests"
        else
          echo "tests=${{ inputs.all_tests }}"
        fi
    - name: Run molecule tests
      run: |
        NUMBER_ISTIO_VERSIONS_TO_TEST="${{ inputs.last_n_istio_versions }}"
        LATEST_ISTIO_VERSIONS="$(curl -s https://api.github.com/repos/istio/istio/releases | jq -r '.[].tag_name' | sort -rV | awk -F. '!seen[$1"."$2]++' | head -n "${NUMBER_ISTIO_VERSIONS_TO_TEST}")"
        echo "Testing with the following versions of Istio:"
        echo "${LATEST_ISTIO_VERSIONS}"
        for iv in ${LATEST_ISTIO_VERSIONS}; do
          echo "Testing with Istio version ${iv} using Helm install"
          if ! ./hack/ci-kind-molecule-tests.sh --istio-version ${iv} --client-exe $(which kubectl) --kind-exe $(which kind) --all-tests "${{ inputs.all_tests }}" --git-clone-protocol https --irc-room "" --upload-logs false --rebuild-cluster true -ci true --operator-installer helm --olm-enabled false; then
            exit $?
          fi
          echo "Testing with Istio version ${iv} using OLM install"
          if ! ./hack/ci-kind-molecule-tests.sh --istio-version ${iv} --client-exe $(which kubectl) --kind-exe $(which kind) --all-tests "${{ inputs.all_tests }}" --git-clone-protocol https --irc-room "" --upload-logs false --rebuild-cluster false -ci true --operator-installer skip --olm-enabled true --olm-version "${{ inputs.olm_version }}"; then
            exit $?
          fi
        done
