name: Report to ReportPortal

on:
  workflow_run:
    workflows: ["Kiali CI"]
    types:
      - completed

jobs:
  merge-reports:
    name: Merge frontend test reports
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion != 'cancelled' }}
    steps:
    - name: Download frontend core test reports
      continue-on-error: true
      uses: actions/download-artifact@v7
      with:
        pattern: 'junit-frontend-core-*-report'
        path: artifacts/
        github-token: ${{ secrets.GITHUB_TOKEN }}
        run-id: ${{ github.event.workflow_run.id }}

    - name: Setup Node.js for merging reports
      uses: actions/setup-node@v6
      with:
        node-version: "20"

    - name: Merge frontend core reports
      continue-on-error: true
      run: |
        npm install -g junit-report-merger
        mkdir -p merged-reports
        jrm merged-reports/combined-report.xml "artifacts/junit-frontend-core-*-report/*.xml"

    - name: Upload merged report
      uses: actions/upload-artifact@v4
      with:
        name: merged-frontend-report
        path: merged-reports/
        retention-days: 1

  report-tests:
    name: Report tests to ReportPortal
    runs-on: ubuntu-latest
    needs: [merge-reports]
    if: ${{ github.event.workflow_run.conclusion != 'cancelled' }}
    container:
      image: quay.io/dno/droute:latest
    steps:
    - name: Check out code
      uses: actions/checkout@v6
      with:
        ref: ${{ github.event.workflow_run.head_sha }}

    # Download backend test results and metadata because workflow_run events triggered by PRs from forks
    # don't have access to PR information in github.event.workflow_run.pull_requests
    # See: https://github.com/orgs/community/discussions/25220
    - name: Download backend test results and metadata
      continue-on-error: true
      uses: actions/download-artifact@v7
      with:
        pattern: '{junit-rest-report,backend-test-metadata,pr-metadata}'
        path: artifacts/
        github-token: ${{ secrets.GITHUB_TOKEN }}
        run-id: ${{ github.event.workflow_run.id }}

    - name: Download merged frontend report
      uses: actions/download-artifact@v7
      with:
        name: merged-frontend-report
        path: frontend-core/cypress/results/

    - name: Extract metadata
      id: metadata
      run: |
        if [ -f artifacts/backend-test-metadata/istio_version.txt ]; then
          ISTIO_VERSION=$(cat artifacts/backend-test-metadata/istio_version.txt)
          echo "istio_version=${ISTIO_VERSION:-unknown}" >> $GITHUB_OUTPUT
        else
          echo "istio_version=unknown" >> $GITHUB_OUTPUT
        fi

        if [ -f artifacts/pr-metadata/pr_number.txt ]; then
          PR_NUMBER=$(cat artifacts/pr-metadata/pr_number.txt)
          echo "pr_number=${PR_NUMBER:-unknown}" >> $GITHUB_OUTPUT
        else
          echo "pr_number=unknown" >> $GITHUB_OUTPUT
        fi

        if [ -f artifacts/pr-metadata/target_branch.txt ]; then
          TARGET_BRANCH=$(cat artifacts/pr-metadata/target_branch.txt)
          echo "target_branch=${TARGET_BRANCH:-unknown}" >> $GITHUB_OUTPUT
        else
          echo "target_branch=unknown" >> $GITHUB_OUTPUT
        fi

        if [ -f artifacts/pr-metadata/kiali_version.txt ]; then
          KIALI_VERSION=$(cat artifacts/pr-metadata/kiali_version.txt)
          echo "kiali_version=${KIALI_VERSION:-unknown}" >> $GITHUB_OUTPUT
        else
          echo "kiali_version=unknown" >> $GITHUB_OUTPUT
        fi

    - name: Report backend tests to ReportPortal
      continue-on-error: true
      uses: ./.github/actions/report-to-reportportal
      with:
        test_suite: 'backend'
        test_results_dir: 'artifacts/junit-rest-report'
        test_file_name: 'junit-rest-report.xml'
        kiali_version: ${{ steps.metadata.outputs.kiali_version }}
        istio_version: ${{ steps.metadata.outputs.istio_version }}
        data_plane_mode: 'sidecar'
        pr_number: ${{ steps.metadata.outputs.pr_number }}
        target_branch: ${{ steps.metadata.outputs.target_branch }}
        data_router_username: ${{ secrets.DATA_ROUTER_USERNAME }}
        data_router_password: ${{ secrets.DATA_ROUTER_PASSWORD }}

    - name: Report frontend core tests to ReportPortal
      continue-on-error: true
      uses: ./.github/actions/report-to-reportportal
      with:
        test_suite: 'cypress'
        test_results_dir: 'frontend-core/cypress/results'
        test_file_name: 'combined-report.xml'
        kiali_version: ${{ steps.metadata.outputs.kiali_version }}
        istio_version: ${{ steps.metadata.outputs.istio_version }}
        data_plane_mode: 'sidecar'
        pr_number: ${{ steps.metadata.outputs.pr_number }}
        target_branch: ${{ steps.metadata.outputs.target_branch }}
        data_router_username: ${{ secrets.DATA_ROUTER_USERNAME }}
        data_router_password: ${{ secrets.DATA_ROUTER_PASSWORD }}
