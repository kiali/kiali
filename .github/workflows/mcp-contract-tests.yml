name: MCP Contract Tests

on:
  workflow_call:
    inputs:
      target_branch:
        required: true
        type: string
      build_branch:
        required: true
        type: string
      istio_version:
        required: false
        type: string
        default: ""
  push:
    paths:
    - 'kiali/routing/routes.go'
    branches:
    - master
    - 'v*.*'
  pull_request:
    paths:
    - 'kiali/routing/routes.go'
    branches:
    - master
    - 'v*.*'
  workflow_dispatch:

env:
  TARGET_BRANCH: ${{ inputs.target_branch || github.base_ref || github.ref_name }}
  BUILD_BRANCH: ${{ inputs.build_branch || inputs.target_branch || github.ref_name }}

jobs:
  mcp_contract_tests:
    name: MCP Contract Tests (kubernetes-mcp-server)
    runs-on: ubuntu-latest
    env:
      # Copied from: https://github.com/bahmutov/cypress-gh-action-split-install/blob/ca3916d4e7240ebdc337825d2d78eb354855464b/.github/workflows/tests.yml#L7-L11
      # prevents extra Cypress installation progress messages
      CI: 1
      # avoid warnings like "tput: No value for $TERM and no -T specified"
      TERM: xterm
    continue-on-error: true
    steps:
    - name: Check out Kiali code
      uses: actions/checkout@v6
      with:
        ref: ${{ inputs.build_branch }}

    - name: Install Helm
      uses: Azure/setup-helm@v4.3.1
      with:
        version: 'v3.18.4'

    - name: Setup node
      uses: actions/setup-node@v6
      with:
        node-version: "20"
        cache: yarn
        cache-dependency-path: frontend/yarn.lock

    - name: Download go binary
      uses: actions/download-artifact@v7
      with:
        name: kiali
        path: ~/go/bin/

    - name: Ensure kiali binary is executable
      run: chmod +x ~/go/bin/kiali

    - name: Install frontend dependencies
      working-directory: ./frontend
      run: yarn install --frozen-lockfile

    - name: Setup KinD cluster with Istio and Kiali
      run: hack/run-integration-tests.sh --test-suite frontend-core-1 --setup-only true $(if [ -n "${{ inputs.istio_version }}" ]; then echo "--istio-version ${{ inputs.istio_version }}"; fi)

    - name: Get Kiali external URL from MetalLB
      id: get_kiali_url
      run: |
        # Wait for Kiali LoadBalancer to get an external IP
        echo "Waiting for Kiali LoadBalancer to get external IP..."
        kubectl wait --for=jsonpath='{.status.loadBalancer.ingress}' -n istio-system service/kiali --timeout=300s

        # Get the external IP from MetalLB
        KIALI_IP=$(kubectl get svc kiali -n istio-system -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
        if [ -z "$KIALI_IP" ]; then
          echo "ERROR: Failed to get Kiali LoadBalancer IP"
          kubectl get svc kiali -n istio-system
          exit 1
        fi

        # Kiali service uses port 80, so the URL is http://IP/kiali
        KIALI_URL="http://${KIALI_IP}/kiali"
        echo "Kiali URL: $KIALI_URL"
        echo "KIALI_URL=${KIALI_URL}" >> $GITHUB_ENV

        # Verify Kiali is accessible
        echo "Verifying Kiali is accessible at ${KIALI_URL}..."
        for i in {1..30}; do
          CURL_OUTPUT=$(curl -s -w "\nHTTP_CODE:%{http_code}" "${KIALI_URL}/api/status" 2>&1)
          HTTP_CODE=$(echo "$CURL_OUTPUT" | grep "HTTP_CODE:" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$CURL_OUTPUT" | sed '/HTTP_CODE:/d')

          if [ "$HTTP_CODE" = "200" ]; then
            echo "Kiali is accessible at ${KIALI_URL}"
            break
          else
            echo "Attempt $i/30: HTTP $HTTP_CODE"
            if [ "$HTTP_CODE" != "200" ]; then
              echo "Curl output:"
              echo "$CURL_OUTPUT"
            fi
          fi

          if [ $i -eq 30 ]; then
            echo "ERROR: Kiali is not accessible after 30 attempts"
            echo "Final curl output:"
            echo "$CURL_OUTPUT"
            exit 1
          fi
          sleep 2
        done

    - name: Check out kubernetes-mcp-server
      uses: actions/checkout@v6
      with:
        repository: containers/kubernetes-mcp-server
        path: kubernetes-mcp-server

    - name: Set up Go for kubernetes-mcp-server
      uses: actions/setup-go@v6
      with:
        go-version-file: kubernetes-mcp-server/go.mod
        cache: true
        cache-dependency-path: kubernetes-mcp-server/go.sum

    - name: Run MCP contract tests
      working-directory: kubernetes-mcp-server
      env:
        KIALI_URL: ${{ env.KIALI_URL }}
      run: |
        cd pkg/kiali/tests/contract
        go test -v

    - name: Get debug info when tests fail
      if: failure()
      working-directory: kiali
      run: |
        mkdir -p debug-output
        hack/ci-get-debug-info.sh --output-directory debug-output || true

    - name: Upload debug info artifact
      if: failure()
      uses: actions/upload-artifact@v6
      with:
        name: debug-info-mcp-contract-tests
        path: kiali/debug-output

